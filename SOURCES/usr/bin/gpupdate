#! /bin/bash
############################################################
#                                                          #
#                         gpupdate                         #
#                                                          #
############################################################
#
# author:    mpuel@in2p3.fr
# date:      vendredi 8 f√©vrier 2013, 11:06:55 (UTC+0100)
# copyright: Copyright (c) by IN2P3 computing centre, Villeurbanne (Lyon), France
#
# usage:  gpupdate
#
# purpose:
#  * for every image updated in vmcatcher's cache:
#    - instanciate
#    - apply policy checks 
#    - publish image if tests succeed

source /usr/share/glancepush/common.sh
source /etc/glancepush/glancepushrc
source $novacreds

if [ "$(pgrep -o gpupdate)" != $$ ]
    then
    _err "another gpupdate process is running, abort"
    exit 1
fi


_debug "gpupdate start"
cd $meta

# check every files
for image in $(updated)
do
    _debug "checking updates for image <$image>"
    # checks if a version of the image is already quarantined
    if [ -n "$(glance_id "${image}.q")" ]
        then
        _err "the image is already quarantined. Something went wrong, please check logs for image <$image>"
        continue
    fi

    # quarantine publication
    gppublish -q "$image"
    if [ $? -ne 0 ]
        then
        _err "error while publishing image <$image> to quarantine zone"
        continue
    fi

    # policy validation
    if gppolcheck "$image"
        then
        _log "policy validation passed for image <$image>"
    else
        _err "image <$image> failed policy validation"
        continue
    fi

    # publication
    if gppublish "$image"
        then
        _log "image <$image> successfully released"
    else
        _err "an error occured while releasing image <$image>"
    fi

    # remove update flag
    update_done "$image"
done
